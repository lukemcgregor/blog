<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  

  <title>How NServiceBus uses MSMQ to provide durable messaging</title>
  <meta name="description" content="NServiceBus is a great messaging technology, in this post we look at how the message handshaking interacts with MSMQ under the the scenes to provide durable messaging.">
  <meta name="author" content="Luke McGregor">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="How NServiceBus uses MSMQ to provide durable messaging">
  <meta name="twitter:description" content="NServiceBus is a great messaging technology, in this post we look at how the message handshaking interacts with MSMQ under the the scenes to provide durable messaging.">
  
  <meta name="twitter:creator" content="staticv0id">
  
  <meta name="twitter:image" content="/images/favicons/favicon-194x194.png" />

  <meta property="og:type" content="article">
  <meta property="og:title" content="How NServiceBus uses MSMQ to provide durable messaging">
  <meta property="og:description" content="NServiceBus is a great messaging technology, in this post we look at how the message handshaking interacts with MSMQ under the the scenes to provide durable messaging.">
  <meta property="og:image" content="/images/favicons/favicon-194x194.png" />

  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" href="/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1521893633085120945">
  <link rel="canonical" href="http://blog.staticvoid.co.nz/2014/how_nservicebus_uses_msmq_to_provide_durable_messaging/">
  <link rel="alternate" type="application/rss+xml" title="StaticVoid" href="/feed.xml">
</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">
	<div class="panel-main">

		<div class="panel-main__inner panel-inverted">
			<div class="panel-main__content">
				<a href="/" title="link to home of StaticVoid">
					<img src="https://www.gravatar.com/avatar/46e93e55b8f4f652201516c2f7bf3323?s=256" class="user-image" alt="Profile Photo">
					<div class="staticvoid-logo">
						<div class="wrapper">
							<div class="code">static void;</div>
							<div class="comment">// Blog</div>
						</div>
					</div>
				</a>
				<hr class="panel-cover__divider">

				<div class="navigation-wrapper">

					<nav class="cover-navigation cover-navigation--primary">
						<ul class="navigation">
							<li class="navigation__item"><a href="/" title="Archive">Archive</a></li>
						</ul>
					</nav>

					<nav class="cover-navigation navigation--social">
						<ul class="navigation">

							
							<!-- Twitter -->
							<li class="navigation__item">
								<a href="http://twitter.com/staticv0id" title="@staticv0id on Twitter" target="_blank">
									<i class="icon icon-social-twitter"></i>
									<span class="label">Twitter</span>
								</a>
							</li>
							   
							<!-- GitHub -->
							<li class="navigation__item">
								<a href="https://www.github.com/lukemcgregor" title="lukemcgregor on GitHub" target="_blank">
									<i class="icon icon-social-github"></i>
									<span class="label">GitHub</span>
								</a>
							</li>
							 

							<!-- RSS -->
							<li class="navigation__item">
								<a href="/feed.xml" title="Subscribe" target="_blank">
									<i class="icon icon-rss"></i>
									<span class="label">RSS</span>
								</a>
							</li>

						</ul>
					</nav>

				</div>

			</div>

		</div>

		<div class="panel-cover--overlay"></div>
	</div>
</header>


    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="2 Jun 2014" class="post-meta__date date">2 Jun 2014</time>
      
    </div>
    <h1 class="post-title">How NServiceBus uses MSMQ to provide durable messaging</h1>
  </header>

  <section class="post">
    <p>NServiceBus is a great tool and lets us send messages between applications. Messaging allows our communications between processes to be resilient to different types of failures. In this post we are going to look specifically about how NServiceBus uses MSMQ. Its useful to understand the underlying mechanisms used to diagnose and debug your NServiceBus based applications.</p>

<p>NServiceBus has two types of messaging, direct messaging and publish/subscribe messaging. We are going to start off looking at direct messaging as its has less moving parts. When talking about direct messaging what we are talking about is the following where we are sending to a specific destination.</p>

<h4 id="sending-to-a-local-queue">Sending to a local queue</h4>

<p>Were going to start off looking at what happens when we send a message to a queue on our local machine. The format of such a send command in NServiceBus is something like the below:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bus</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="s">"service2.input"</span><span class="p">,</span><span class="n">myMessage</span><span class="p">);</span>
</code></pre></div></div>

<p>When our process <code class="highlighter-rouge">Service1</code> gives NServiceBus this message, it serialises the object <code class="highlighter-rouge">myMessage</code> and gives that to MSMQ. MSMQ will then put that message into a queue on the local machine named <code class="highlighter-rouge">service2.input</code>. At the other end we may have another process <code class="highlighter-rouge">Service2</code> running NServiceBus which is listening to the <code class="highlighter-rouge">service2.input</code> queue and when the message appears deserialises it, executes the handler code and removes the message from the queue. This is the simplest case of sending a message with NServiceBus.</p>

<p><img src="/images/posts/2014/how_nsb_uses_msmq_to_provide_durable_messaging%201.png" alt="How NServiceBus uses MSMQ to provide durable messaging" /></p>

<p>If we look at how this works for us for reliability what we see is that as soon as we have sent the message it is persisted to disk. If <code class="highlighter-rouge">Service2</code> isn’t running the message is not lost it simply waits until the service is next available. If <code class="highlighter-rouge">Service2</code> errors while handling the message (and our queue is enabled as transactional) the message stays on the queue until processing is complete so it isn’t lost due to a failure. One of the interesting side effects of this is that messages may be handled more than once in a transactional system if the transaction was not completed before the error occurred.</p>

<h4 id="sending-to-a-queue-on-another-machine">Sending to a queue on another machine</h4>

<p>The second scenario we will look at is what if we are sending a message to another machine.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bus</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="s">"service2.input@machine2"</span><span class="p">,</span><span class="n">myMessage</span><span class="p">);</span>
</code></pre></div></div>

<p>MSMQ introduces a new concept in order to deal with this flow; an outgoing queue. For every remote queue a machine sends messages to MSMQ keeps a local outgoing queue. When we send our message MSMQ writes it first to the outgoing queue and it is then transmitted to the remote machine once the transmission is complete the message is removed from the outgoing queue. This means we get the same durability but across the network. If machine 2 is not contactable the message remains in the outgoing queue until it becomes available and has been sent.</p>

<p><img src="/images/posts/2014/how_nsb_uses_msmq_to_provide_durable_messaging%202.png" alt="how nsb uses msmq to provide durable messaging" /></p>

<h4 id="publish-subscribe">Publish subscribe</h4>

<p>Publish subscribe is a little more complex as there are two separate flows which occur.</p>

<p>The first is the subscription flow. When you start a subscribing application it sends a message to the publishing application with details of what messages you are subscribing to and the address of the subscribing input queue (where to send the messages to). The publishing application receives these subscription messages and updates its local subscription store (in our case a queue).</p>

<p><img src="/images/posts/2014/how_nsb_uses_msmq_to_provide_durable_messaging%20subscribe.png" alt="how nsb uses msmq to provide durable messaging - subscribe" /></p>

<p>The second stage occurs when a message is published.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bus</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">myMessage</span><span class="p">);</span>
</code></pre></div></div>

<p>When a message is published the publisher first checks its local subscription storage and finds a list of subscribers which are interested in the particular published message. It then loops through and sends the message to each of the listed subscribers.</p>

<p><img src="/images/posts/2014/how_nsb_uses_msmq_to_provide_durable_messaging%203.png" alt="how nsb uses msmq to provide durable messaging - 3" /></p>

<p>In the case where a remote machine is subscribed to a message the same flow occurs with the addition of an outgoing queue.</p>

<p><img src="/images/posts/2014/how_nsb_uses_msmq_to_provide_durable_messaging%204.png" alt="how nsb uses msmq to provide durable messaging -4" /></p>

<p>So what does all of this mean and why does it matter. By understanding the paths that messages go through debugging your applications becomes much simpler. When you find a message isnt being delivered where you expect you can look in the following places to work out where things went wrong:</p>

<ul>
  <li>The subscription storage queue (if its a subscription), make sure your subscriber is listed</li>
  <li>If sending remotely, the outgoing message queue (with the remote machine offline)</li>
  <li>The service 2 input queue (with the receiving service turned off)</li>
</ul>

<p>I also find some tools are useful to see where things are going. I personally use the windows MSMQ tools (under Services and Applications in Computer Management) <a href="http://blog.halan.se/post/Service-Bus-MQ-Manager-v3-Released.aspx">Service Bus MQ Manager</a>.</p>

<p><img src="http://blog.halan.se/image.axd?picture=2012%2f12%2fmainScreen2.png" alt="Service Bus MQ Manager" /></p>

  </section>
  <section id="disqus_thread"></section><!-- /#disqus_thread -->
</article>

    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://blog.staticvoid.co.nz/2014/how_nservicebus_uses_msmq_to_provide_durable_messaging/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '/2014/how_nservicebus_uses_msmq_to_provide_durable_messaging'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };

      (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//staticvoidblog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
       })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



<script type="application/ld+json">
{ "@context": "http://schema.org",
 "@type": "BlogPosting",
 "headline": "How NServiceBus uses MSMQ to provide durable messaging",
 "wordcount": "847",
 "publisher": "StaticVoid",
 "mainEntityOfPage": "http://blog.staticvoid.co.nz/2014/how_nservicebus_uses_msmq_to_provide_durable_messaging/",
 "publisher": {
   "@type": "Organization",
   "name": "StaticVoid",
  "logo":{
    "@type":"ImageObject",
    "url": "http://blog.staticvoid.co.nz/images/favicons/favicon-194x194.png"
  }
 },
 "datePublished": "2014-06-02 00:00:00 +0000",
 "description": "NServiceBus is a great messaging technology, in this post we look at how the message handshaking interacts with MSMQ under the the scenes to provide durable messaging.",
   "author": {
    "@type": "Person",
    "name": "Luke McGregor"
	,"image": "https://www.gravatar.com/avatar/46e93e55b8f4f652201516c2f7bf3323?s=256"
  }
 }
</script>

      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2018 Luke McGregor. All rights reserved.</span>
</footer>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1521893633085120945"></script>


    </div>
  </body>
</html>