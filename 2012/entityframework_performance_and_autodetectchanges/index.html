<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  

  <title>EntityFramework Performance and AutoDetectChanges</title>
  <meta name="description" content="Entity Framework change tracking performs well when using small sets of data however as the number of changes grows it becomes inefficient. In this post we look at what causes this degradation and how we can tune EF to perform better with large data sets.">
  <meta name="author" content="Luke McGregor">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="EntityFramework Performance and AutoDetectChanges">
  <meta name="twitter:description" content="Entity Framework change tracking performs well when using small sets of data however as the number of changes grows it becomes inefficient. In this post we look at what causes this degradation and how we can tune EF to perform better with large data sets.">
  
  <meta name="twitter:creator" content="staticv0id">
  
  <meta name="twitter:image" content="/images/favicons/favicon-194x194.png" />

  <meta property="og:type" content="article">
  <meta property="og:title" content="EntityFramework Performance and AutoDetectChanges">
  <meta property="og:description" content="Entity Framework change tracking performs well when using small sets of data however as the number of changes grows it becomes inefficient. In this post we look at what causes this degradation and how we can tune EF to perform better with large data sets.">
  <meta property="og:image" content="/images/favicons/favicon-194x194.png" />

  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" href="/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1529806071253709115">
  <link rel="canonical" href="http://blog.staticvoid.co.nz/2012/entityframework_performance_and_autodetectchanges/">
  <link rel="alternate" type="application/rss+xml" title="StaticVoid" href="/feed.xml">
</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">
	<div class="panel-main">

		<div class="panel-main__inner panel-inverted">
			<div class="panel-main__content">
				<a href="/" title="link to home of StaticVoid">
					<img src="https://www.gravatar.com/avatar/46e93e55b8f4f652201516c2f7bf3323?s=256" class="user-image" alt="Profile Photo">
					<div class="staticvoid-logo">
						<div class="wrapper">
							<div class="code">static void;</div>
							<div class="comment">// Blog</div>
						</div>
					</div>
				</a>
				<hr class="panel-cover__divider">

				<div class="navigation-wrapper">

					<nav class="cover-navigation cover-navigation--primary">
						<ul class="navigation">							
							<li class="navigation__item"><a href="/" title="Tech">Tech</a></li>
							<li class="navigation__item"><a href="/personal" title="Personal">Personal</a></li>
						</ul>
					</nav>

					<nav class="cover-navigation navigation--social">
						<ul class="navigation">

							
							<!-- Twitter -->
							<li class="navigation__item">
								<a href="http://twitter.com/staticv0id" title="@staticv0id on Twitter" target="_blank">
									<i class="icon icon-social-twitter"></i>
									<span class="label">Twitter</span>
								</a>
							</li>
							   
							<!-- GitHub -->
							<li class="navigation__item">
								<a href="https://www.github.com/lukemcgregor" title="lukemcgregor on GitHub" target="_blank">
									<i class="icon icon-social-github"></i>
									<span class="label">GitHub</span>
								</a>
							</li>
							 

							<!-- RSS -->
							<li class="navigation__item">
								<a href="/feed.xml" title="Subscribe" target="_blank">
									<i class="icon icon-rss"></i>
									<span class="label">RSS</span>
								</a>
							</li>

						</ul>
					</nav>

				</div>

			</div>

		</div>

		<div class="panel-cover--overlay"></div>
	</div>
</header>


    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="7 May 2012" class="post-meta__date date">7 May 2012</time>
      
    </div>
    <h1 class="post-title">EntityFramework Performance and AutoDetectChanges</h1>
  </header>

  <section class="post">
    <h3 id="what-is-auto-detect-changes">What is Auto Detect Changes?</h3>
<p>Entity framework has two methods of change detection built into the framework, Instant Notification and Snapshot. Most people seem to use the Snapshot mechanism as it is the easiest to configure and most well known. I will cover the Instant Notification (Proxy Entities) Mechanism in a later post.</p>

<p>Detect Changes has two purposes:</p>

<ol>
  <li>Snapshot change detection takes a copy of every entity in the system when they are added to the Entity Framework tracking graph. Then as entities change each entity is compared to its snapshot to see any changes. This occurs by calling the <code class="highlighter-rouge">DetectChanges</code> method. What’s important to know about <code class="highlighter-rouge">DetectChanges</code> is that it has to go through all of your tracked entities each time its called, so the more stuff you have in your context the longer it takes to traverse.</li>
  <li>To run ‘Fixups’ across the context so that navigation properties are updated throughout the context.</li>
</ol>

<p>For more details on Detect Changes <a href="http://blog.oneunicorn.com/">Arthur Vickers</a> from the Entity Framework team has an awesome <a href="http://blog.oneunicorn.com/2012/03/10/secrets-of-detectchanges-part-1-what-does-detectchanges-do/">blog series on how DetectChanges works</a> in much greater detail.</p>

<p>What Auto Detect Changes does is plugs into events which happen on the context and calls detect changes as they occur.</p>

<h3 id="auto-detect-changes-performance">Auto Detect Changes Performance</h3>

<p><img src="/images/posts/2012/insert-comparison.png" alt="Insert Comparison" /></p>

<p><img src="/images/posts/2012/insert-reletive-performance.png" alt="Insert Relative Performance" /></p>

<p><img src="/images/posts/2012/update-comparison.png" alt="Update Comparison" /></p>

<p><img src="/images/posts/2012/update-reletive-performance.png" alt="Update Relative Performance" /></p>

<p>So wow, lets take a look at those results a little more closely.</p>

<p>From the graphs above you can see that with Auto Detect Changes <strong>off</strong> the relationship between <em>time</em> and <em>number of items</em> is approximately linear ie O(N), and with Auto Detect Changes <strong>on</strong> the relationship is quadratic O(N<sup>2</sup>), see <a href="http://math.stackexchange.com/a/138301/30204">here</a>. That means the more items that we modify to our context in Entity Framework the longer it takes to perform each modification.</p>

<h3 id="why-is-auto-detect-changes-so-slow-with-many-items">Why is Auto Detect Changes so slow with many items?</h3>

<p>As we have touched on earlier whenever we make a change to the context DetectChanges gets called. Detect changes enumerates all attached items</p>

<p>This means that if we are adding 1000 items the first item we add enumerates no items, the second enumerates 1 item and so on. So if we do the math for this we get:</p>

<script type="math/tex; mode=display">1 + 2 + 3 + ... + 999 + 1000</script>

<p>or:</p>

<script type="math/tex; mode=display">\sum_{i=0}^N(N-i)=\sum_{i=0}^Ni=\frac{N(N+1)}2\;</script>

<p>where in this case N is 1000. This function is of the class O(N<sup>2</sup>) which explains why it takes so long to add a large number of items.&lt;</p>

<h3 id="how-do-i-turn-it-off">How do I turn it off?</h3>

<p>Fortunately its really easy to turn Auto Detect Changes on and off. Simply use:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">context</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">AutoDetectChangesEnabled</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</code></pre></div></div>

<p>But be careful while you have Auto Detect Changes off Entity Framework will not be tracking the changes you have made or fixing up navigation properties. MSDN says this may mean that turning off Auto Detect Changes <em>“can potentially introduce subtle bugs into your application if not used correctly.”</em>(<a href="https://msdn.microsoft.com/en-us/library/gg696177(v=vs.103).aspx">MSDN</a>)</p>

<p>Once your done with your bulk changes its worth while manually calling DetectChanges so that you leave the context in an aware state. You can do this as follows:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">context</span><span class="p">.</span><span class="n">ChangeTracker</span><span class="p">.</span><span class="nf">DetectChanges</span><span class="p">();</span>
</code></pre></div></div>

<h3 id="why-would-i-leave-it-on">Why would I leave it on?</h3>

<p>Detect changes is actually really useful in most cases. As you can see from my results when you are dealing with less than 100 items in the context the performance impact is negligible. In most cases its much simpler to leave Auto Detect Changes on. As Arthur Vickers aptly puts it <em>“change tracking and the DetectChanges method are a part of the stack where there is a tension between ease-of-use and performance”</em> (<a href="http://blog.oneunicorn.com/2012/03/10/secrets-of-detectchanges-part-1-what-does-detectchanges-do/">Secrets of DetectChanges</a>).</p>

<p>My general feeling is that if you are doing batch modifications to the database you should be turning Auto Detect Changes off, otherwise it adds complexity for very little gain.</p>

<h3 id="well-worth-reading">Well worth reading</h3>

<p>Change tracking is the central and most complex component of Entity Framework, so if you use EF its well worth while to understand some of how it works. Here’s some resources that go into a little more detail:</p>

<ul>
  <li><a href="http://blog.oneunicorn.com/2012/03/10/secrets-of-detectchanges-part-1-what-does-detectchanges-do/">Secrets of DetectChanges Series</a> - Arthur Vickers</li>
  <li><a href="https://msdn.microsoft.com/en-us/library/gg696177(v=vs.103).aspx">Change Tracking</a> - MSDN</li>
</ul>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async="">
</script>

  </section>
  <section id="disqus_thread"></section><!-- /#disqus_thread -->
</article>

    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://blog.staticvoid.co.nz/2012/entityframework_performance_and_autodetectchanges/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '/2012/entityframework_performance_and_autodetectchanges'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };

      (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//staticvoidblog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
       })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



<script type="application/ld+json">
{ "@context": "http://schema.org",
 "@type": "BlogPosting",
 "headline": "EntityFramework Performance and AutoDetectChanges",
 "wordcount": "727",
 "publisher": "StaticVoid",
 "mainEntityOfPage": "http://blog.staticvoid.co.nz/2012/entityframework_performance_and_autodetectchanges/",
 "publisher": {
   "@type": "Organization",
   "name": "StaticVoid",
  "logo":{
    "@type":"ImageObject",
    "url": "http://blog.staticvoid.co.nz/images/favicons/favicon-194x194.png"
  }
 },
 "datePublished": "2012-05-07 00:00:00 +0000",
 "description": "Entity Framework change tracking performs well when using small sets of data however as the number of changes grows it becomes inefficient. In this post we look at what causes this degradation and how we can tune EF to perform better with large data sets.",
   "author": {
    "@type": "Person",
    "name": "Luke McGregor"
	,"image": "https://www.gravatar.com/avatar/46e93e55b8f4f652201516c2f7bf3323?s=256"
  }
 }
</script>

      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2018 Luke McGregor. All rights reserved.</span>
</footer>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1529806071253709115"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28637942-1', 'auto');
  ga('send', 'pageview');
</script>


    </div>
  </body>
</html>